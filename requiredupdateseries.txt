좋아요. 기획서의 **목차(챕터/섹션) 단위로** 현재 코드에 구현된/부분 구현된/미구현된 항목을 전부 대조해서 “빠진 부분 목록”을 만들어드릴게요.  
먼저 GDD에서 **모든 헤더(목차)** 를 뽑고, 그 다음 서버/클라 코드에서 대응되는 구현 지점을 찾아 매핑하겠습니다.

GDD 파일에서 `# / ## / ###` 헤더를 전부 추출해서 “목차 트리”를 만든 뒤, 각 항목이 코드의 어느 파일/기능으로 구현됐는지(완료/부분/미구현) 매핑해서 누락 리스트를 만들겠습니다. 먼저 목차(헤더)부터 뽑아올게요.

목차를 “전부” 기준으로 비교하려면, 먼저 GDD에서 **장/절 헤더를 빠짐없이 수집**하고(챕터 1~23 + 부록), 그 다음 각 항목을 코드의 **서버/클라/DB**에 매핑해 “완료/부분/미구현”으로 태깅하겠습니다. 지금은 헤더 목록이 아직 일부만 보이므로, 먼저 파일에서 **모든 챕터 헤더/부 헤더를 자동 추출**하겠습니다.
요청대로 **GDD(v11.1)의 목차(장/절/항목)별로** 현재 코드(서버/클라/DB)를 대조해서 `완료/부분/미구현`을 표로 정리하겠습니다.

진행 방식은 이렇게 할게요.

- **[1]** GDD에서 1~23장 + 부록의 **세부 헤더(##/###)** 를 챕터별로 수집
- **[2]** 코드베이스에서 각 항목에 대응하는 구현 지점(파일/함수/엔드포인트/테이블)을 찾아 매핑
- **[3]** “덜된 부분(미구현/부분구현)”을 목차 기준으로 누락 리스트로 정리 + 우선순위 제안

먼저 코드베이스에서 챕터별 핵심 구현 지점을 빠르게 스캔하겠습니다.
목차별로 “완료/부분/미구현”을 정확히 매핑하려면, 우선 GDD의 `##/###` 헤더를 전부 수집해 챕터별 체크리스트를 만든 다음, 코드에서 대응 파일/테이블/이벤트를 찾아 연결해야 합니다. 지금은 `## 1~10` 일부까지만 로그에 잡혀서, **11~23장과 부록의 세부 헤더를 추가로 추출**하겠습니다.


요청하신 대로 **GDD 목차(1~23장 + 부록) 기준으로** 현재 코드가 어디까지 반영됐는지 `완료/부분/미구현`으로 매핑해 “덜 된 부분”을 정리하겠습니다.  
지금부터는 챕터별 핵심 키워드를 코드 전체에서 검색해 **근거(파일/함수)** 를 확보한 뒤, GDD 요구사항과 비교해 누락 항목을 도출하겠습니다.


아래는 **@[attached_assets/integrated_gdd_v11_full_1767165854504.md] (v11.1)**의 **목차(1~23장 + 부록)** 를 기준으로, 현재 코드베이스(`server/`, `client/`, [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0))와 **대조해서 “덜된 부분(부분 구현/미구현)”을 식별**한 결과입니다.  
(근거 파일 예: [server/turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0), [server/websocket.ts](cci:7://file:///d:/civil2/civilization-forge/server/websocket.ts:0:0-0:0), [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0), [server/llm.ts](cci:7://file:///d:/civil2/civilization-forge/server/llm.ts:0:0-0:0), [client/src/pages/Game.tsx](cci:7://file:///d:/civil2/civilization-forge/client/src/pages/Game.tsx:0:0-0:0), [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0))

---

# 제 1부: 게임 개요 및 핵심 시스템 (1~3장)

## 1장. 게임 소개 / 승리 조건
- **상태: 부분 구현**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): `VictoryCondition`, `game_rooms.victoryCondition` 존재
- **덜된 부분**
  - **정복 승리(100개 도시 점령)** 판정 로직 없음
  - **턴 제한 승리(300턴 + 점수 산정)** 로직 없음
  - 점수 계산(도시 등급/자원/특산물/전투승/동맹/거래) 상세 반영 없음  
    (현재 `gamePlayers.score`는 있으나 산정/갱신 로직이 없음)

## 2장. 실시간 턴 시스템 (Time Flow)
- **상태: 부분 구현(핵심 턴 루프는 있음, 상세 규칙 다수 미반영)**
- **근거**
  - [server/websocket.ts](cci:7://file:///d:/civil2/civilization-forge/server/websocket.ts:0:0-0:0): 턴 타이머, `turn_resolving` → [resolveTurn()](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:41:0-110:1) → `turn_resolved` → `turn_end`
  - [server/turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): 액션 수집/처리(attack/move/build/recruit), 자원 생산, 뉴스 저장
- **덜된 부분**
  - GDD의 “턴 시작(T-Start)”에 명시된 항목 중:
    - **병력 회복(병원 효과)** 미구현
    - **AI 의사결정** 미구현
    - **첩보 활동** 미구현
  - “Resolution(판정)”에 명시된 항목 중:
    - **거래 체결** 미구현
  - 턴 이벤트 페이즈(시작 1초/액션/판정 4초) 같은 **세부 타이밍 모델링**은 단순화됨

## 3장. 플레이어 및 세션 관리
- **상태: 부분 구현**
- **근거**
  - [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0): 방 생성/조회/삭제, 국가/도시 선택
  - [server/websocket.ts](cci:7://file:///d:/civil2/civilization-forge/server/websocket.ts:0:0-0:0): join_room, player_ready(일부), select_nation/city 브로드캐스트
  - [client/src/pages/Lobby.tsx](cci:7://file:///d:/civil2/civilization-forge/client/src/pages/Lobby.tsx:0:0-0:0), [client/src/pages/Game.tsx](cci:7://file:///d:/civil2/civilization-forge/client/src/pages/Game.tsx:0:0-0:0): 입장/게임 진입
- **덜된 부분**
  - “방 0명 → 비활성/턴 중지/7일 후 삭제” 같은 **장기 세션 정책** 미구현
  - “관전/AI 조종 모드” 미구현
  - “플레이어 이탈 상태 관리/재접속 처리”는 일부만(기본 join/leave) 수준

---

# 제 2부: 월드 및 환경 (4~6장)

## 4장. 월드 맵 시스템
- **상태: 부분 구현**
- **근거**
  - `client/src/components/game/PixiHexMap.tsx` (맵 렌더링)
  - [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0) seed/tiles/cities 로딩 로직 일부
- **덜된 부분**
  - **전장의 안개(Fog of war) / 시야 시스템** 미구현(검색 결과 거의 없음)
  - 동맹 시야 공유 등(동맹/우호에 따른 공개 범위) 미구현
  - “실제 지리 기반 맵/대륙별 분포/고정맵”은 데이터/시각화가 GDD 수준으로 확정 반영되었는지 추가 확인 필요(현재는 seed 로직/도시 로더 기반)

## 5장. 타일 및 지형 시스템
- **상태: 부분 구현**
- **근거**
  - [server/llm.ts](cci:7://file:///d:/civil2/civilization-forge/server/llm.ts:0:0-0:0): 지형 multiplier 일부 반영(산/숲/평지/사막/바다)
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): terrain 타입 존재
- **덜된 부분**
  - “도시 클러스터 중앙+주변 6타일” 규칙이 **게임 규칙/점령/생산/방어**에 일관되게 적용되는지 부족
  - “해군은 항구 있는 도시에서만 바다 진입” 규칙 미구현(현재 이동 제한 로직 거의 없음)
  - 지형별 이동 비용(1.2/1.3 등) 미구현

## 6장. 국가 및 도시 시스템
- **상태: 부분 구현**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): NationsInitialData/CityGradeStats/CityData 구조
  - [server/gddLoader.ts](cci:7://file:///d:/civil2/civilization-forge/server/gddLoader.ts:0:0-0:0), [routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0): 도시 시드/선택
- **덜된 부분**
  - **도시 동적 성장(City Score, 성장/수도 이전)** 로직 없음
  - **내전/반란 처리** 미구현
  - “도시 점령 시 도시 소유 타일 일괄 점령”이 GDD대로 완전 구현인지 부족  
    (현재 [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0)는 “타일/도시 ownerId 변경”은 하되, 도시 주변 타일까지 연쇄 점령/행정 처리 등은 없음)

---

# 제 3부: 경제 및 자원 (7~10장)

## 7장. 자원 시스템(돈/식량/병력/특산물)
- **상태: 부분 구현**
- **근거**
  - [server/turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): [processResourceProduction()](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:451:0-535:1)에서 gold/food 생산 및 유닛 upkeep(식량 차감) 처리
  - `specialties` 테이블 존재 및 증가 로직 존재
- **덜된 부분**
  - GDD의 “자원 저장 한계/저장소 건물 영향” 미구현
  - “특산물 가치(기본 가치/변동)” 시스템 미구현
  - 병력(‘troops’) 자원이 GDD만큼 세밀하게 운영되는지 부족(현재는 unit 테이블 + 타일 troops 합산의 혼합)

## 8장. 생산 시스템(공식/행복도 배율/건물 보너스)
- **상태: 부분 구현(현재는 도시 등급 기반 고정 생산)**
- **근거**
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): 도시 등급별 gold/food/병력/특산물 증가
- **덜된 부분**
  - GDD의 생산 공식(세율/행복도/건물/지형 보너스) **미반영**
  - “건물 보너스 상세(돈 생산 건물/지형 보너스)” **미반영**  
    (가장 큰 갭: **건물 효과가 생산/전투/첩보에 실제로 적용되지 않음**)

## 9장. 특산물 시스템(15종, 보유효과)
- **상태: 부분 구현(테이블/수량 증감은 있으나 ‘효과’는 없음)**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): SpecialtyType 정의, `specialties` 테이블
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): 특산물 amount 증가
- **덜된 부분**
  - “특산물 보유 효과(행복도/거래/첩보/외교 비용 등)” 미구현
  - “기본 가치/거래 가치 변동” 미구현

## 10장. 시민 행복도 시스템
- **상태: 미구현(표시/필드 일부만)**
- **근거**
  - `CityData.happiness` 필드 및 CityPanel 표시 흔적(검색됨)
- **덜된 부분**
  - 행복도 공식/증감 요인/구간별 생산 배율/반란 확률 등 **전체 미구현**
  - 세율(`taxRate`)이 존재해도 생산/행복도에 연결되지 않음

---

# 제 4부: 군사 및 전투 (11~14장)

## 11장. 병과 시스템(6병과/스탯/상성/이동)
- **상태: 부분 구현**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): `UnitTypeDB` 6종 + `UnitStats`
  - `client/Game.tsx`: 이동/공격/징병 UI에서 6병과 입력
  - [server/turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): move/attack/recruit 모두 unitType 단위로 처리
- **덜된 부분**
  - **병과 상성(가위바위보/공성/해군 제약)** 미구현(전투력 계산에 상성 반영 없음)
  - **이동력/지형 이동 비용/해군 이동 제약(항구 필요)** 미구현
  - “첩보 병과는 전투 불가/발각 시 사망” 등 특수 룰 미구현

## 12장. 전투 시스템(프로세스/손실/점령/약탈)
- **상태: 부분 구현**
- **근거**
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): 공격 처리 → `judgeBattle()` → 손실 적용 → 승리 시 소유권 변경/생존 병력 이동
- **덜된 부분**
  - GDD의 손실 공식/승률 랜덤(±10%) 등은 현재 구현과 다름(단순 비율 기반)
  - **약탈(자원 이전/약탈량/감소)** 미구현
  - 도시 점령 후 “도시가 가진 모든 타일 점령”, “수도 이전”, “국가 버프 해제” 등 미구현

## 13장. LLM 전투 판정 상세(70/30 + 전략점수 세부항목)
- **상태: 부분 구현(70/30 핵심은 구현, 세부 채점 루브릭은 미반영)**
- **근거**
  - [server/llm.ts](cci:7://file:///d:/civil2/civilization-forge/server/llm.ts:0:0-0:0): `finalScore = 0.7*statsScore + 0.3*strategyScore` + Gemini/Deepseek fallback
- **덜된 부분**
  - GDD 13.2의 “지형 일치성/병과 연계성/심리전/첩보 활용” 같은 **세부 점수 항목**을 프롬프트/채점으로 구조화하지 않음
  - “전략 미입력 시 0점” 규칙: 현재 기본값이 0.5로 시작하는 구조라 **GDD와 불일치 가능**  
    (이건 코드 재확인이 필요하지만, 현재 `strategyScore` default가 0.5로 보임)

## 14장. 점령 및 약탈 시스템
- **상태: 부분 구현(점령 일부만)**
- **근거**
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): 타일/도시 owner 변경은 있음
- **덜된 부분**
  - 약탈/점령 페널티/도시 귀속 타일 처리/수도 이전 등 대부분 미구현

---

# 제 5부: 건물 및 시설 (15~16장)

## 15장. 건물 시스템(20종/규칙/수리/카테고리별 효과)
- **상태: 부분 구현(건설/큐는 있으나 효과/수리/파괴가 없음)**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): `BuildingType` 20종, `BuildingStats`(비용/턴/효과 문자열), `buildings` 테이블
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): build 액션 처리 + 공사 진행(`turnsRemaining`)
  - `client/Game.tsx`: 건설 다이얼로그 + 큐 표시
- **덜된 부분(핵심)**
  - **건물 효과가 실제 게임 로직(생산/전투/첩보/외교)에 적용되지 않음**
  - **수리 시스템/파괴 조건/내구도/피해** 미구현
  - “건설 위치 규칙(특정 타일/도시 등)” 단순화됨(현재 cityId만)
  - “레벨업/업그레이드 단계적 효과”는 테이블에 level 있지만 실질 반영 부족

## 16장. ROI(투자 회수 분석)
- **상태: 미구현(문서/밸런싱 참고용)**
- 코드에 ROI 계산/표시 없음 (정상: 보통은 기획 참고 데이터)

---

# 제 6부: 외교 및 정보 (17~19장)

## 17장. 외교 시스템(5단계/우호도/행동/동맹 상세/외교 채팅)
- **상태: 부분 구현**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): `diplomacy` 테이블(status/favorability)
  - [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0): `/api/rooms/:id/diplomacy`, `/api/rooms/:id/diplomacy/propose` 추가(최근)
  - `client/Game.tsx`: 외교 데이터 로드/액션 호출 연결(최근)
- **덜된 부분**
  - GDD의 **비용/조건**(예: 동맹 비용 2000, 우호도 조건 80+) 일부만/임시 구현
  - **동맹 효과(공동 방어/자원 공유/시야 공유)** 미구현
  - **배신(페널티/낙인/턴 디버프)** 미구현
  - **항복/휴전/비침략/단계적 관계 변화** 미구현 또는 매우 단순
  - **외교 채팅(채널 분리: 동맹/국가/개인)** 미구현(현재 채팅은 global only)

## 18장. 거래 시스템
- **상태: 미구현**
- **근거**
  - 코드 검색에서 trade/deal 관련 핵심 로직/테이블/엔드포인트 부재
- **덜된 부분**
  - 거래 제안/수락/역제안/체결/거래 기록
  - 거래 품목(돈/식량/특산물/병력/시야공유/포로 등) 전부 미구현
  - 거래 시 우호도/행복도 변화 미구현

## 19장. 첩보 시스템(첩보력/스파이 생성/활동/방첩/성장)
- **상태: 미구현(“spy” 병과만 존재)**
- **근거**
  - `UnitTypeDB`에 spy 존재, [llm.ts](cci:7://file:///d:/civil2/civilization-forge/server/llm.ts:0:0-0:0)/schema에 spy 언급 일부
- **덜된 부분**
  - 첩보력(0~100) 성장/효과
  - 스파이 생성 조건(외교관저 등) / 파견 / 정찰/공작/암살/파괴/자원 탈취
  - 방첩/발각/사망/뉴스 범위(당사자만) 등 전부 미구현

---

# 제 7부: UI/UX 및 데이터 (20~23장)

## 20장. UI/UX 설계
- **상태: 부분 구현**
- **근거**
  - `client/Game.tsx`: 상단바(턴/자원), 좌측 탭, 하단 채팅
  - `PixiHexMap`, [CityPanel](cci:1://file:///d:/civil2/civilization-forge/client/src/components/game/CityPanel.tsx:93:0-247:1), `DiplomacyPanel`, `NewsFeed` 존재
- **덜된 부분**
  - GDD에서 정의한 “좌/우 패널 역할 분화”, “알림/외교 채팅 분리 창”, “첩보 탭”, “건물 카테고리별 건설 메뉴” 등 UI 디테일 미달
  - 전투 UI에서 “태세 선택 UI”는 GDD에 있으나, 현재는 **자유 텍스트 전략만**(태세 미구현/또는 의도 변경 필요)

## 21장. 뉴스 시스템(규칙/공개범위/LLM 문체)
- **상태: 부분 구현**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0): `news` 테이블(category)
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0): 전투 뉴스 insert, WS로 `news_update` 송신
  - [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0): 외교 액션 시 news insert(최근)
  - [server/llm.ts](cci:7://file:///d:/civil2/civilization-forge/server/llm.ts:0:0-0:0): `generateNewsNarrative()` 존재(하지만 사용처 제한적)
- **덜된 부분**
  - GDD의 “뉴스 공개 범위(전체/동맹/당사자)” 미구현
  - 첩보 뉴스(당사자만) 미구현
  - LLM 기반 “뉴스 문체 자동 생성”은 함수만 있고, 실제 이벤트 생성 파이프라인에 전면 적용되지 않음

## 22장. AI 영주 시스템
- **상태: 미구현(필드만)**
- **근거**
  - `gamePlayers.isAI`, `aiDifficulty` 필드 존재
- **덜된 부분**
  - 매 턴 AI 의사결정(확장/방어/공격/외교/거래/건설)
  - AI 전략 텍스트 생성(LLM 전투용)
  - 난이도별 성향 반영

## 23장. DB 스키마
- **상태: 부분 구현(핵심 테이블은 다수 존재하지만 컬럼/구조가 GDD와 상이)**
- **근거**
  - [shared/schema.ts](cci:7://file:///d:/civil2/civilization-forge/shared/schema.ts:0:0-0:0)에 다수 테이블 존재: rooms/players/cities/tiles/units/buildings/specialties/news/chat/diplomacy/battles/turn_actions 등
- **덜된 부분(불일치)**
  - GDD의 스키마는 `effect JSON`, `restriction`, `rarity`, `city_states`, `troop_movements`, `diplomacy_relations` 등 **세분 테이블**을 전제  
    현재 구현은 더 단순한 형태로 통합/축약됨
  - 예: `buildings` 테이블에 GDD의 `effect(JSON)`, `restriction` 같은 필드 없음(대신 `BuildingStats`에 문자열)
  - 특산물 보유 효과/희귀도 등 마스터 데이터 구조 미흡

---

# “덜된 부분” 핵심 요약 (우선순위 Top)

아래는 **GDD 대비 “미구현/부분구현” 중 게임플레이 영향이 큰 순서**입니다.

1. **건물 효과의 실제 적용(생산/전투/첩보/행복/외교 비용)**  
   - 현재: 건설/큐만 있음, 효과는 텍스트로만 존재
2. **거래 시스템(18장) 전체**
3. **첩보 시스템(19장) 전체**
4. **행복도/세율/반란(10장) 전체 + 생산 공식(8장)과 연동**
5. **점령/약탈/수도 이전/도시 귀속 타일 처리(14장)**
6. **AI 영주(22장) 전체**
7. **뉴스 공개 범위/LLM 뉴스 생성 전면 적용(21장)**

---

## 다음 단계 제안
원하시면, 위 “덜된 부분”을 **GDD 절 번호 그대로** 더 쪼개서(예: `15.4.1 훈련소`, `19.3.2 침투`처럼) 각 항목에 대해:
- **현재 코드에서 가장 가까운 위치(파일/함수/테이블)**
- **정확히 빠진 데이터/로직**
- **구현 시 변경해야 할 스키마/턴 처리/WS 이벤트**
까지 “작업 설계서” 형태로 이어서 정리해드릴게요.

먼저 어느 파트를 “GDD 기준으로 완성”하는 게 목표인가요?
- `건물 효과 적용(15장/8장 연동)`부터
- `거래(18장)`부터
- `첩보(19장)`부터

================================================================
요청하신 GDD(v11) 기준 **기능 구현 현황/누락/연결성**을 점검하려면, 먼저 GDD 문서의 주요 섹션(게임 루프, 경제/전투/외교/첩보/AI/UI 등)을 추출하고, 그에 대응하는 **서버 라우트·턴 처리·웹소켓·DB 스키마·클라이언트 페이지**를 교차검증하는 방식으로 진행하겠습니다.  

우선 **GDD 파일과 핵심 엔트리 파일들**(routes/websocket/turnResolution/schema)을 열어서 현재 코드 상태를 정확히 확인한 뒤,  
- **구현됨 / 부분구현 / 미구현** 매트릭스  
- **유기적 연결(데이터 플로우, 트리거, 저장/조회, UI 반영)** 점검  
- **긴급 수정(버그/설계 불일치/데이터 무결성/보안)**  
- **추가 디테일(예: 난이도별 AI 성향 확장, 밸런싱, 콘텐츠 확장)**  
을 정리해서 제안드리겠습니다.  

먼저 관련 파일들을 읽겠습니다.



지금부터는 GDD v11.1의 **요구 기능 목록을 “체크리스트化”**해서, 코드베이스(서버 라우트/턴 루프/DB 스키마/클라 UI)와 1:1로 매핑하며 **구현/부분구현/미구현 + 연결성(트리거/저장/반영) + 긴급 수정/추가 디테일**을 정리하겠습니다.

먼저 빠르게 코드 전역에서 GDD 핵심 키워드(세율/도시성장/유지비/승리조건/동맹/전쟁/첩보/거래/건설턴/안개/해군 등) 구현 위치를 찾아 “어디에 뭐가 있는지” 지도를 만들겠습니다.


GDD v11.1은 범위가 매우 커서 “문서 전체를 한 번에” 구현 여부를 단정하기보단, **(1) 핵심 루프/데이터 스키마 적합성 → (2) 각 시스템별 서버 트리거/DB/클라 UI 연결 → (3) 누락·불일치·TODO 목록화 → (4) 우선순위(긴급/중요/개선)** 순으로 점검하겠습니다.  

지금은 제가 이미 확인한 `turnResolution.ts / websocket.ts / schema.ts` 기반으로 1차 진단을 내리고, 바로 이어서 **서버 routes(거래/첩보/건설/세율/도시성장/승리조건)**와 **클라 주요 패널(맵/도시/전투/거래/첩보/외교/뉴스)**를 추가로 훑어 “빠진 연결”을 확정하겠습니다.
GDD v11.1을 “문서 요구사항 → (DB 스키마 / 서버 라우트 / 턴 루프 / 웹소켓 이벤트 / 클라 UI)”로 매핑해서 **구현/부분구현/미구현**을 표로 정리하고, 특히 **연결이 끊긴 지점(서버는 있는데 UI가 없음, UI는 있는데 API가 없음, 턴에서 처리되는데 입력 경로가 없음)**을 우선적으로 잡겠습니다.

지금 바로:
- GDD에서 **거래/첩보/세율/유지비/도시성장/안개/해군/승리조건** 요구사항을 검색
- 서버에서 **실제 라우트 존재 여부**(trades/spies 등)와 턴 처리 연결 여부 확인
- 클라에서 **턴 이벤트/맵 시야 처리/패널 연결** 확인
을 하겠습니다.


GDD v11.1 요구사항 대비로 “구현 여부 + 시스템 간 연결(입력→턴큐→해결→뉴스/상태반영→UI)”을 점검하려면, 현재 서버 API 엔드포인트가 충분히 존재하는지가 1차 관문입니다. 방금 읽힌 [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)가 **205줄짜리 최소 라우트만 포함**하고 있어서(거래/외교/첩보/건설/유닛/턴액션 API가 안 보임), 우선 **실제 코드베이스에 다른 라우팅 파일이 있는지**부터 확인하겠습니다. 바로 서버 폴더 구조와 라우트 정의 위치를 찾아볼게요.


## 0) 결론(요약)
현재 코드베이스는 [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0) 중심으로 **턴 기반 처리(전투/건설큐/첩보 일부/점수승리 등 “코어 엔진”)는 꽤 구현**되어 있는데, **GDD v11.1 수준의 “게임 플레이로 이어지는 API/초기 시딩/클라 UI 연결”이 크게 끊겨있습니다.**  
특히 **[server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)가 매우 축약된 상태(약 205줄)로, 클라이언트가 호출하는 외교/거래/첩보/건설/이동/공격 등의 REST API가 대부분 없습니다.** 이 상태면 “기능이 코드에 있어도 실제 게임에서 못 쓰는” 구간이 많습니다.

아래는 GDD 요구사항 대비 **구현/부분/미구현 + 유기적 연결성 + 긴급 수정** 관점의 1차 리뷰입니다.

---

## 1) “유기적으로 연결” 관점에서 가장 긴급한 문제들 (High)
### 1. **서버 API 레이어가 클라이언트 기대와 불일치 (치명적)**
- **클라이언트(Game.tsx/TradePanel/EspionagePanel 등)**는 예를 들어:
  - `/api/rooms/:id/diplomacy`
  - `/api/rooms/:id/trades`, `/api/rooms/:id/trades/propose`, `/api/rooms/:id/trades/:tradeId/respond`
  - `/api/rooms/:id/spies/...`
  같은 엔드포인트를 호출하도록 작성돼 있는데,
- 현재 확인된 **[server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)에는 위 엔드포인트들이 존재하지 않습니다.**
- 결과:
  - UI는 “외교/거래/첩보 패널이 있어도” 실제로는 404/500으로 동작 불가
  - 턴 엔진([turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0))이 있어도 “플레이어 액션(turnActions) 생성 경로”가 약해짐

**권장 조치(긴급):**
- [routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)가 의도대로 축약본인지/실수로 덮인 것인지 먼저 확정해야 합니다.
  - 이전 코드맵에선 [routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)가 1000줄대였고 [seedRoom()](cci:1://file:///d:/civil2/civilization-forge/server/routes.ts:1087:0-1332:1)에서 맵/도시 시딩까지 했습니다.
  - 지금 상태는 “초기 시딩/외교/거래/첩보/유닛 액션 API”가 사라진 형태라서 **실제 플레이가 막힐 가능성이 큼**.

### 2. **초기 시딩(seedRoom) 로직이 GDD 요구를 충족하지 못함**
GDD는 **100개 도시/타일/특산물/초기 병력/도시 클러스터(중앙+6)**까지 전제인데, 현재 [routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)의 [seedRoom()](cci:1://file:///d:/civil2/civilization-forge/server/routes.ts:1087:0-1332:1)는:
- 타일 생성/도시 생성/특산물 배치가 없음
- **AI 플레이어 생성만** 수행

즉 **게임 월드가 생성되지 않거나 빈 상태일 수 있습니다.**  
(그리고 AI도 도시/타일/유닛이 없으면 의사결정이 의미가 없어집니다.)

**권장 조치(긴급):**
- GDD 부록 A 기반 [gddLoader.ts](cci:7://file:///d:/civil2/civilization-forge/server/gddLoader.ts:0:0-0:0)(도시 데이터)와 연동하여
  - hex 타일 생성
  - 도시 생성(100개)
  - 도시 중심 타일 지정
  - 특산물 배치
  - 초기 병력/유닛 생성
  을 복구/구현해야 합니다.

### 3. **전장의 안개/시야 시스템이 “플레이어별”이 아니라 “게임 전체”로 동작(설계 불일치)**
- 스키마: `hex_tiles.isExplored`는 **타일 단위 bool**인데, 이건 “누구에게 탐험되었는가”를 표현할 수 없습니다.
- [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0)의 [updateFogOfWar()](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:2023:0-2054:1)는 `isExplored = true`로 업데이트 → **한 명이 정찰하면 모두에게 공개되는 구조**가 됩니다.
- 스키마에 `fogOfWar: jsonb<number[]>()`가 있으나 “동맹 시야 공유”도 TODO로 남아있습니다.

**권장 조치(긴급~중요):**
- GDD의 시야/정찰/첩보를 살리려면 **플레이어별 fog 데이터**가 필요합니다.
  - 예: `player_fog_tiles (gameId, playerId, tileId)` 테이블
  - 또는 `game_players.fogTileIds jsonb` 같은 방식
- 클라이언트에서 타일 렌더링 시 “내 fog에 없는 타일은 어둡게” 처리해야 유기적으로 연결됩니다.

---

## 2) GDD 주요 시스템별 구현 수준(1차 매트릭스)
아래는 “서버 엔진 존재 여부” + “API/클라 연결”까지 포함한 평가입니다.

### A. 실시간 턴 시스템 (GDD 2장)
- **구현됨(코어):**
  - [websocket.ts](cci:7://file:///d:/civil2/civilization-forge/server/websocket.ts:0:0-0:0)의 턴 타이머/페이즈 브로드캐스트
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0)의 `runTurnStart/runActionsPhase/runResolutionPhase`
- **부분구현/리스크:**
  - 플레이어가 액션을 제출하는 “공식 입력 경로(turnActions insert)”가 REST로 충분히 제공되는지 불명확(현재 routes.ts에 없음)

### B. 전투/점령/LLM 판정 (GDD 11~14장)
- **구현됨(코어):**
  - `judgeBattle()` 호출, 전투 결과/손실 적용, 점령 시 타일 owner 변경 등 상당 부분 존재
- **부분구현:**
  - 동맹 자동참전/지원(공동방어) TODO
  - 수도 이전/국가 버프 처리 TODO
  - 해군/항구/수송선 등 바다 규칙은 “데이터는 있으나 규칙 완결성”은 추가 점검 필요

### C. 건설/시설 (GDD 15~16장)
- **구현됨(부분):**
  - 건설 시작(액션), 건설 큐 턴 감소/완료 처리([processBuildQueue](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:2207:0-2239:1))
- **미구현/누락 가능성:**
  - “도시 주변 6타일 건설 슬롯/타일당 1~3개” 같은 제한은 현재 스키마/로직상 불명확
  - 건물 효과(생산량/방어/첩보 등)가 턴 생산/전투에 반영되는 범위는 추가 점검 필요

### D. 경제/자원/유지비/세율 (GDD 7~10장)
- **부분구현:**
  - 자원 생산/시장 변동(simulateMarketFluctuation) 등 존재
- **중요 누락 가능성:**
  - `cities.taxRate` 필드가 있는데 “세율 조정 API/UI/턴 반영”이 명확히 연결돼 있지 않음
  - 병력 유지비(식량 차감)도 GDD 핵심인데 실제 구현 위치/계산식이 GDD와 일치하는지 추가 확인 필요

### E. 외교 (GDD 17장)
- **부분구현:**
  - `diplomacy` 테이블 존재
  - 턴에서 외교 페이즈 처리 골격 존재([processDiplomacyPhase](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:289:0-307:1)), 배신/휴전/공동방어 등 TODO
- **연결성 이슈(치명 가능):**
  - 클라가 호출하는 외교 API가 현재 routes.ts에 없음

### F. 거래 (GDD 18장)
- **엔진은 존재(부분):**
  - 턴 액션에서 `proposeTrade/respondTrade`, [processTradeSettlement](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:1534:0-1538:1) 호출 로직 존재
- **연결성 이슈(치명 가능):**
  - 클라 `TradePanel`은 REST 엔드포인트 기반인데 routes.ts에 없음(현재 상태 기준)

### G. 첩보/스파이 (GDD 19장)
- **엔진은 존재(부분):**
  - spy mission 실행/발각/자원탈취/사보타주/정찰 등 일부 구현
- **미구현:**
  - 암살(유닛 제거) TODO
  - 방첩 효과의 실질적 데이터 반영/스택/범위 등 추가 필요
- **연결성 이슈(치명 가능):**
  - 클라에서 스파이 생성/배치 API 호출하는데 routes.ts에 없음

### H. AI (GDD 3.1.3 + 2장 AI 의사결정)
- **부분구현:**
  - [turnResolution.ts](cci:7://file:///d:/civil2/civilization-forge/server/turnResolution.ts:0:0-0:0)에 난이도 프로필(간단한 multiplier), AI 메모리(aiMemory) 등 존재
- **긴급 개선점:**
  - GDD의 난이도 정의(쉬움=수동/방어, 어려움=공격적 확장)를 만족하려면 지금보다 훨씬 디테일한 “전략 성향 모델”이 필요
- **그리고 무엇보다**: AI가 실제로 플레이하려면 “초기 도시/유닛/타일 소유”가 있어야 함(현재 seedRoom 구조로는 결여 가능성이 큼)

---

## 3) 앞으로 “더 디테일하게 추가” 추천 (Medium)
### 1) **난이도별 AI 성향 확장(예시 설계)**
현재는 `maxActions`, `attackMultiplier` 같은 수치형 프로필 중심으로 보이는데, GDD에 맞추려면 아래처럼 “성향 벡터”가 필요합니다.
- **전략 페이즈 모델:** 확장(초반) → 안정화(중반) → 승리(후반) 목표 전환
- **행동 가중치:** 확장(도시 점령 우선), 경제(건설/거래 우선), 군사(공격 우선), 외교(동맹 선호), 첩보(정찰/사보타주 선호)
- **위험 선호도:** 손실 허용치/공격 임계치(상대 병력 대비, 방어시설, 지형, 동맹 개입 위험)
- **상대별 관계 메모리:** “배신당함/거래 성사율/전쟁 피해” 기반 외교 태도 변화

### 2) 도시 성장/승격/수도 이전(콘텐츠 핵심)
[updateCityGrowth()](cci:1://file:///d:/civil2/civilization-forge/server/turnResolution.ts:2243:0-2265:1)는 현재 score 계산 후 로그 수준이라,
- 승격(마을→일반→주요→수도)
- 수도 이전(원 수도 함락/새 수도 선정)
- 수도 전용 건물/버프
가 **게임의 큰 재미 포인트**라 우선순위 높습니다.

### 3) 시야/정찰/동맹 시야 공유 완성
GDD의 “정보전”을 살리는 핵심이라, 현재의 전역 isExplored 방식은 반드시 개선 필요합니다.

---

## 4) 다음 단계 제안(제가 이어서 진행할 작업)
현재 가장 중요한 불확실성은 **“routes.ts가 왜 이렇게 축약돼 있나”**입니다. 이게 의도된 구조(WS 중심)인지, 실수로 큰 라우트 파일이 덮였는지에 따라 점검 결과가 완전히 달라집니다.

다음 턴으로 제가 진행하면 좋은 순서는:
1. **(필수)** [server/routes.ts](cci:7://file:///d:/civil2/civilization-forge/server/routes.ts:0:0-0:0)가 원래 설계대로 전체 API를 포함해야 하는지 확인 (git 히스토리/이전 버전 대비)
2. **클라에서 호출하는 API 목록을 추출**해서 서버에 실제로 존재하는지 매핑표 작성
3. [seedRoom](cci:1://file:///d:/civil2/civilization-forge/server/routes.ts:1087:0-1332:1)이 GDD의 “맵/도시/특산물/초기 병력”을 생성하는지 검증(없으면 최우선 복구)
4. 그 다음에 AI/외교/거래/첩보의 TODO를 GDD 우선순위대로 채워넣기

원하시면 제가 다음 응답에서 **“GDD 기능 체크리스트(장별)”를 표 형태로 만들어서**  
`구현/부분/미구현 + 코드 위치 + 필요한 연결(라우트/WS/UI)`까지 한 번에 정리해드릴게요.